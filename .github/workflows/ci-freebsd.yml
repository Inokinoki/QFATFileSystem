name: Build and Test on FreeBSD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Qt 5 on FreeBSD 14.1
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build and Test in FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.1"
          usesh: true
          prepare: |
            pkg install -y cmake qt5 ninja

          run: |
            uname -a

            # Generate test images
            cd tests
            chmod +x generate_test_images.sh
            ./generate_test_images.sh

            # Verify images
            ls -lh data/
            test -f data/fat16.img || exit 1
            test -f data/fat32.img || exit 1

            # Configure
            cd ..
            cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_TESTING=YES

            # Build
            cmake --build build --config ${{env.BUILD_TYPE}}

            # Test
            cd build
            ctest -C ${{env.BUILD_TYPE}} --output-on-failure --verbose
